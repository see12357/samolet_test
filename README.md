
***

# AI Система оценки недвижимости (Case Study)

Интеллектуальный агент для оценки рыночной стоимости квартир. Система объединяет высокоточную ML-модель на базе градиентного бустинга и AI-агента (LLM) для автоматического сбора данных и интерпретации результатов.

## 1. Как запускать

Для работы требуется Python 3.11+ и установленная Ollama.

### Предварительная настройка
1.  **Установить зависимости:**
    ```bash
    pip install -r requirements.txt
    playwright install chromium
    ```
2.  **Запустить локальную модель через Ollama:**
    (Для запуска может потребоваться авторизация в аккаунте Ollama)
    ```bash
    ollama pull deepseek-v3.1:671b-cloud
    ollama serve
    ```
    *(если запуск через приложение Ollama, возможно, потребуется включение сетевого режима в настройках)*

3.  **Проверка артефактов:**
    Убедитесь, что в папке `model/` находятся файлы `model.cbm` и `inference_meta.json`.

### Запуск агента
```bash
python main.py
```

### Проверка работы обучения
Для воспроизведения результатов моделирования и проверки метрик запустите скрипт из папки `train`:
```bash
python train/train.py
```

---

## Особенности запуска и работы

### 1. Инициализация (Первый запуск)
При самом первом запуске парсера библиотеке Playwright может потребоваться несколько секунд для инициализации браузерного движка Chromium. При первом запуске скрипта обучения `train.py` модель CatBoost может использовать системные ресурсы для построения графиков визуализации.

### 2. Подготовка данных (Каждый запуск)
Система работает в режиме реального времени. При старте `main.py` происходит:
- Загрузка весов модели CatBoost из бинарного файла.
- Инициализация SHAP-эксплейнера для интерпретации предсказаний.
- Загрузка JSON-метаданных с коэффициентами районов (district_map).

О готовности системы сообщит появление строки ввода:
```text
 (deepseek-v3.1:671b-cloud) Real Estate Agent Started
 Вставьте ссылку на Самолет или введите параметры.
 Type 'q' to exit.

 User: 
```

### 3. Известные проблемы (macOS)
На операционной системе macOS при вводе запросов на кириллице иногда может возникать ошибка кодировки (`UnicodeDecodeError`). Это связано с особенностями работы терминала. Ошибка не приводит к падению. Решение: просто введите вопрос повторно.

### 4. Стабильность парсинга (Web Scraping)
В текущей версии реализован парсинг через headless-браузер. Однако сайты застройщиков часто используют динамическую подгрузку данных (Nuxt.js) и системы защиты. 
- **Ограничение:** Текущая реализация чувствительна к изменениям фронтенд-верстки сайта. 
- **Потребность в API:** Для стабильной работы в продакшн-окружении требуется переход на официальное API застройщика. В случае ошибки парсинга агент вежливо предложит ввести данные вручную.

---

## 2. Методология моделирования (ML Core)

В рамках проекта реализован полный цикл разработки модели (от очистки данных до XAI).

**Техническая реализация:**
- **Алгоритм:** CatBoost Regressor (глубина 9, Huber Loss для сглаживания ошибок на выбросах).
- **Target:** `log1p(PricePerMeter)`. Использование логарифма позволило устранить перекос распределения цен (Skewness).
- **Feature Engineering:**
    - Парсинг комнат и выделение "Евро"-планировок.
    - Оценка эффективности площади (`kitchen_ratio`, `area_per_room`).
    - Динамический расчет медианы района (`district_level`) с нечетким поиском названий.
- **Data Quality Safeguard:** Автоматическая замена невозможных нулевых значений площадей (кухни, комнаты) на `NaN` для корректного инференса.

**Метрики (результаты обучения):**
- **MAPE:** ~14.3% (высокая точность для рынка недвижимости).
- **R²:** ~0.80 (модель объясняет 80% факторов ценообразования).
- **MAE:** ~66,000 руб/м².

---

## 3. Архитектура Агента и Инструменты

Агент реализован на базе **LangChain** и работает в режиме ReAct (Reasoning + Acting).

**Инструменты (Tools):**
- `evaluate_by_url`: Использует Playwright для извлечения скрытого стейта страницы (`__NUXT_DATA__`). Получает точные площади всех помещений и класс объекта.
- `evaluate_manual`: Инструмент для ручного ввода характеристик (район, площадь, этаж).

**Логика работы:**
1. Агент анализирует запрос пользователя.
2. При наличии ссылки вызывает парсер. При наличии текста — инструмент ручного расчета.
3. Модель предсказывает цену и рассчитывает **SHAP-значения** (вклад признаков).
4. Агент переводит технические веса в человекочитаемый отчет на русском языке.

---

## 4. Структура проекта
- `app/` — Продакшн-модули (инференс, парсер, препроцессор).
- `data/` — Исходный датасет для обучения.
- `model/` — Файлы обученной модели и коэффициенты районов.
- `train/` — Скрипты для обучения, тюнинга и визуализации метрик.
- `main.py` — Точка входа в интерфейс агента.

## 5. Чек-лист выполнения требований

| Требование | Статус | Реализация |
| :--- | :---: | :--- |
| **Прогноз цены за м²** | ✅ | Модель предсказывает цену за м², общая стоимость рассчитывается динамически. |
| **Параметры планировки** | ✅ | Учтены: площадь, комнаты, этажность, высота потолков, тип отделки. |
| **Географическое положение** | ✅ | Реализован учет районов через медианные уровни цен и нечеткий поиск. |
| **Обобщающая способность** | ✅ | Подтверждена через GroupKFold валидацию (тестирование на новых ЖК). |
| **Интерпретируемость** | ✅ | Реализовано через SHAP values, интегрированные в ответ AI-агента. |
| **Схема разделения данных** | ✅ | Использована схема 60/30/10 с защитой от утечек данных по объектам. |
| **Метрики качества** | ✅ | Предоставлены MAPE, R², MAE и RMSLE. |
| **Ручной ввод (Manual)** | ✅ | Агент распознает параметры из свободного текста пользователя. |
| **Ввод по ссылке (Link)** | ✅ | Автоматический парсинг через Playwright (поддержка Nuxt/Next.js структур). |
| **Отчетность** | ✅ | Сформирован отчет с описанием допущений и ограничений системы. |

---

## 6. Примеры работы системы

### А. Ручной ввод (Manual Input)
Агент распознает параметры из неструктурированного текста и вызывает соответствующий инструмент.

**Запрос пользователя:**
> "Оцени квартиру: ЖК Новоград Павлино, тип недвижимость Квартира, этаж 21 из 22, общая площадь 21.26 м2, кухня 4.72 м2, без отделки."

**Логика выполнения:**
1.  **Tool Call:** `evaluate_manual(district='ЖК Новоград Павлино', area=21.26, floor=21, floors_total=22, rooms=1)`
2.  **ML Result:** `ОЦЕНКА: 10,630,663 руб. Факторы: district_level (+14.5%), TotalArea (+11.9%)`
3.  **Final Answer:** 
    > "**Оценка квартиры:** 10 630 663 рублей. 
    > Основные факторы: престижность района добавила 14.5% к стоимости, а оптимальная площадь объекта — еще 11.9%."

### Б. Ввод по ссылке (Link-Based Input)
Система автоматически извлекает данные, недоступные при обычном парсинге, используя эмуляцию браузера.

**Запрос пользователя:**
> "Сколько стоит эта квартира? https://samolet.ru/project/novograd-pavlino/flats/299723/"

**Логика выполнения:**
1.  **Tool Call:** `evaluate_by_url(url='https://samolet.ru/...')`
2.  **Parsing:** Playwright извлекает объект `__NUXT_DATA__` (скрытый JSON страницы).
3.  **ML Result:** Расчет на основе реальных технических характеристик со страницы.
4.  **Final Answer:** Агент выводит стоимость и краткое резюме по объекту.

### В. Обработка ошибок и стабильность
Если автоматический парсинг невозможен (например, из-за блокировки сайта), система сохраняет работоспособность.

**Лог ошибки:**
`[TOOL RESULT]: Ошибка при обработке ссылки: Playwright Error: Timeout exceeded.`

**Реакция агента:**
> "К сожалению, не удалось автоматически получить данные с сайта. Пожалуйста, введите параметры (площадь, этаж, район) вручную, и я мгновенно проведу расчет."

---

## 7. Допущения и ограничения

*   **API vs Scraper:** Текущий парсер зависит от верстки сайта. Для стабильной работы в продакшне рекомендуется переход на официальное API.
*   **Гео-факторы:** Модель не учитывает точное расстояние до метро в минутах, что является основным фактором оставшейся погрешности (14%).
*   **Ценообразование:** Прогноз отражает рыночную стоимость; цены застройщика могут быть выше за счет включенных страховок и ипотечных субсидий.

## 8. Что можно улучшить (Backlog)
*   Интеграция с Google Maps/Yandex Maps API для автоматического расчета инфраструктурного индекса.
*   Внедрение Dadata API для нормализации адресов.
*   Добавление анализа планировок через Computer Vision.
*   Работа с MCP
*   RAG система с собственными практиками подсчета, чтобы агент выполнил все по ним.
***
